<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Flashcard â€“ Chá»§ Ä‘á»™ng há»c tá»« vá»±ng</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { font-family: Arial, sans-serif; background: #f2f4f7; padding: 18px; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 24px;
      border-radius: 14px; box-shadow: 0 5px 20px rgba(0,0,0,0.12); }

    #textArea { border: 1px solid #ccc; padding: 12px; min-height: 150px;
      border-radius: 8px; background: #fafafa; }

    .flashcard { width: 300px; height: 200px; perspective: 1000px; margin: 20px auto; cursor: pointer; }
    .inner { width: 100%; height: 100%; transition: .6s; transform-style: preserve-3d; position: relative; }
    .flipped .inner { transform: rotateY(180deg); }

    .side {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      border-radius: 14px; background: white; padding: 20px;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .back { transform: rotateY(180deg); }

    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; font-size: 14px; }
    th { background: #eee; }
  </style>
</head>

<body>
<div class="container">

  <h2>âœ¨ Flashcard â€“ BÃ´i Ä‘en 1 tá»« tiáº¿ng Anh Ä‘á»ƒ xem nghÄ©a</h2>

  <div id="textArea" contenteditable="true">
    Paste Ä‘oáº¡n vÄƒn vÃ o Ä‘Ã¢y rá»“i bÃ´i Ä‘en 1 tá»« tiáº¿ng Anh báº¥t ká»³â€¦
  </div>

  <p>Tá»« Ä‘Ã£ chá»n: <b id="selectedWord">â€“</b></p>
  <p id="status">â³ Äang táº£i dá»¯ liá»‡u tá»« Google Sheet...</p>

  <div id="flashcardContainer"></div>

  <h3>ğŸ“š Danh sÃ¡ch tá»« Ä‘Ã£ há»c</h3>
  <table>
    <thead>
      <tr>
        <th>Word</th>
        <th>IPA</th>
        <th>Meaning</th>
        <th>Example</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

</div>

<script>

let dictionary = {};

// LINK CSV Google Sheet cá»§a anh
const SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vT-jY5M7TU_NLeGdbIA5jczQI1tkJVW4FFb_zwOQm1G3qBkl8n38l-X4QKbd2iXjLSdKBt22hAWbJn8/pub?gid=0&single=true&output=csv";

// ===== 1) Load CSV tá»« Google Sheet =====
async function loadCSV() {
  try {
    const res = await fetch(SHEET_URL);
    let csv = await res.text();

    let lines = csv.split(/\r?\n/);
    lines.shift(); // remove header

    lines.forEach(line => {
      if (!line.trim()) return;
      let parsed = parseCSV(line);
      if (parsed.length < 4) return;

      let word = parsed[0].trim().toLowerCase();
      dictionary[word] = {
        word,
        ipa: parsed[1].trim(),
        meaning: parsed[2].trim(),
        example: parsed[3].trim(),
      };
    });

    document.getElementById("status").innerText = "âœ… ÄÃ£ táº£i xong dá»¯ liá»‡u tá»« Google Sheet.";
  } catch (err) {
    console.error(err);
    document.getElementById("status").innerText = "âŒ KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u.";
  }
}
loadCSV();

// ===== CSV PARSER CHUáº¨N (xá»­ lÃ½ dáº¥u pháº©y vÃ  dáº¥u ngoáº·c kÃ©p) =====
function parseCSV(str) {
  let arr = [];
  let current = "";
  let insideQuotes = false;

  for (let i = 0; i < str.length; i++) {
    let c = str[i], nc = str[i+1];

    if (c === '"' && insideQuotes && nc === '"') {
      current += '"';
      i++;
    } else if (c === '"') {
      insideQuotes = !insideQuotes;
    } else if (c === "," && !insideQuotes) {
      arr.push(current); current = "";
    } else {
      current += c;
    }
  }
  arr.push(current);
  return arr;
}

// ===== 2) BÃ´i Ä‘en chá»¯ =====
document.addEventListener("mouseup", handleSelection);
document.addEventListener("keyup", handleSelection);

function handleSelection() {
  let raw = window.getSelection().toString().trim();
  if (!raw) return;

  let word = raw.replace(/[^A-Za-z]/g, "").toLowerCase();
  if (!word) return;

  document.getElementById("selectedWord").innerText = word;

  if (!dictionary[word]) {
    document.getElementById("status").innerText = "âŒ Tá»« nÃ y chÆ°a cÃ³ trong báº£ng.";
    return;
  }

  showFlashcard(dictionary[word]);
  saveToHistory(dictionary[word]);
  document.getElementById("status").innerText = "âœ¨ ÄÃ£ táº¡o flashcard.";
}

// ===== 3) Hiá»ƒn thá»‹ Flashcard =====
function showFlashcard(card) {
  document.getElementById("flashcardContainer").innerHTML = `
    <div class="flashcard" onclick="this.classList.toggle('flipped')">
      <div class="inner">
        <div class="side front">
          <h2>${card.word}</h2>
          <i>${card.ipa}</i>
        </div>
        <div class="side back">
          <p><b>NghÄ©a:</b> ${card.meaning}</p>
          <p><b>VÃ­ dá»¥:</b> ${card.example}</p>
        </div>
      </div>
    </div>
  `;
}

// ===== 4) LÆ°u lá»‹ch sá»­ =====
function saveToHistory(card) {
  let list = JSON.parse(localStorage.getItem("history") || "[]");
  if (!list.some(i => i.word === card.word)) {
    list.push(card);
    localStorage.setItem("history", JSON.stringify(list));
  }
  renderTable();
}

function renderTable() {
  let body = document.getElementById("tableBody");
  body.innerHTML = "";
  let list = JSON.parse(localStorage.getItem("history") || "[]");

  list.forEach(item => {
    body.innerHTML += `
      <tr>
        <td>${item.word}</td>
        <td>${item.ipa}</td>
        <td>${item.meaning}</td>
        <td>${item.example}</td>
      </tr>
    `;
  });
}
renderTable();

</script>
</body>
</html>
